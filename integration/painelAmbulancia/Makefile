#######################################################################
# 	Environment configuration
#######################################################################
# Active Configuration
DEFAULTCONF=Debug
CONF=$(DEFAULTCONF)

# All Configurations
ALLCONFS=Debug Release 


#######################################################################
# 	Directories
#######################################################################
SCADE=C:/Program Files (x86)/Esterel Technologies/SCADE R16.2.1/SCADE
SCADE_INCLUDE="$(SCADE)/include"
SCADE_DISPLAY_CONFIG="C:/Program Files (x86)/Esterel Technologies/SCADE R16.2.1/SCADE Display/config/a661_description/a661.xml"
SCADE_BIN=$(SCADE)/bin

KCG_TRACE="$(SCADE_GEN_DIR)/kcg_trace.xml"
DISPLAY_DF="./../../DF/painelAmbulancia/alertaOcorrencia.sgfx"
UA_DF_LINK="./../../UA/painelAmbulancia/painelAmbulancia.sdy"

SRC_DIR=src
BUILD_DIR=build
LIB_DIR=lib
LIBS=-lm
DIST_DIR=dist

LIB_REST_DIR=./../librest# HTTP client library
SCADE_GEN_DIR=./../../UA/painelAmbulancia/KCG# Files generated by SCADE


#######################################################################
# 	Compiler configuration
#######################################################################
CC=gcc

CSOURCES = $(wildcard $(SRC_DIR)/*.c)
SCADE_GEN_SOURCES = $(wildcard $(SCADE_GEN_DIR)/*.c)
LIB_REST_SOURCES = $(wildcard $(LIB_REST_DIR)/*.c)

INCLUDES=-I$(SRC_DIR) -I$(LIB_REST_DIR) -I$(SCADE_GEN_DIR) -I$(SCADE_INCLUDE) -I"$(SCADE)"
	
CFLAGS = -ansi -std=c99 $(INCLUDES)
LDFLAGS=-L$(LIB_DIR) $(LIBS)

#######################################################################
# 	RULES
#######################################################################
win32: ${DIST_DIR}/win32/painelAmbulancia.exe

############################################################
#	Compile the object code into an executable.
#	Depends on the object files. 
#$(CSOURCES:.c=.o) $(patsubst src/%.c, $(BUILD_DIR)/%.o,$(CSOURCES))
# $@ = target name
# $^ = target dependencies
# $(CSOURCES:.c=.o) -> replace the .c suffix by .o
############################################################
${DIST_DIR}/win32/painelAmbulancia.exe: $(patsubst $(SRC_DIR)/%.c, $(BUILD_DIR)/%.o, $(CSOURCES)) $(patsubst $(SCADE_GEN_DIR)/%.c, $(BUILD_DIR)/%.o, $(SCADE_GEN_SOURCES)) $(patsubst $(LIB_REST_DIR)/%.c, $(BUILD_DIR)/%.o, $(LIB_REST_SOURCES))
	@echo "=====> Building $@... Configuration=$(CONF)"
	$(CC) -o $@ $^ $(LIBS)   

############################################################
#	Compile the source code into objects.
#	Depends on the source files. 
#
# $@ = target name
# $< = first target dependency
#
############################################################
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) -c $< $(CFLAGS) -o $@

############################################################
#	Compile the files generated by SCADE. 
#
# $@ = target name
# $< = first target dependency
#
############################################################
$(BUILD_DIR)/%.o: $(SCADE_GEN_DIR)/%.c
	$(CC) -c $< $(CFLAGS) -o $@
	
############################################################
#	Compile the LIB_REST files. 
#
# $@ = target name
# $< = first target dependency
#
############################################################
$(BUILD_DIR)/%.o: $(LIB_REST_DIR)/%.c
	$(CC) -c $< $(CFLAGS) -o $@

############################################################
#	Generate the UA adaptor using the SCADE utilities. 
#	The generated files are put in the SCADE KCG directory.
#
############################################################
genUA:  
	$(shell "$(SCADE_BIN)/uaadaptor" -n $(SCADE_DISPLAY_CONFIG) -k $(KCG_TRACE) -sdy $(UA_DF_LINK) -outdir $(SCADE_GEN_DIR) $(DISPLAY_DF)) 

rebuild: clean win32
	
	

clean:
	@echo "=====> Cleaning $@... Configuration=$(CONF)"
	rm -f $(BUILD_DIR)/*.o 
	rm -f $(DIST_DIR)/win32/*
	rm -f $(DIST_DIR)/lnx86/*
	
.PHONY: clean
